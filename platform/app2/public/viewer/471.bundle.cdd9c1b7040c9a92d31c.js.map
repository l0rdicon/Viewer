{"version":3,"file":"471.bundle.cdd9c1b7040c9a92d31c.js","mappings":"qLAGA,MAAMA,EAAW,CACfC,UAAW,EACXC,OAAQ,EACRC,YAAa,GAqEf,QAlEA,SAAwBC,GAMrB,IANsB,gBACvBC,EAAe,aACfC,EAAY,cACZC,EAAa,YACbC,EAAc,UAAS,oBACvBC,GACDL,EACC,MAAM,wBAAEM,GAA4BL,EAAgBM,SAEpD,OAAO,IAAIC,SAAQC,eAAeC,EAASC,GACzC,MAAMC,QAsBV,SAAqBN,EAAyBH,GAC5C,OAAO,IAAIK,SAAQ,SAASE,EAASC,GACnC,MAAME,EAAU,yCACVC,EAAU,CACd,CACEC,KAAMC,EAAAA,GAAAA,EAAiBC,UACvBC,KAAM,KACNC,MAAOvB,EAASE,QAElB,CACEiB,KAAMC,EAAAA,GAAAA,EAAiBI,QACvBF,KAAM,MACNC,MAAOvB,EAASG,cAGdsB,EAAWC,IACfhB,EAAwBiB,OACxBb,EAAQY,EAAO,EAGjBhB,EAAwBkB,KAAK,CAC3BrB,gBACAY,KAAM,OACNF,UACAC,UACAO,WACAI,eAAgBA,KACdnB,EAAwBiB,OACxBb,EAAQd,EAASE,OAAO,GAG9B,GACF,CAtD+B4B,CACzBpB,EACAH,GAGF,GAAIS,IAAiBhB,EAASG,YAAa,CACzCM,GAAqBsB,SAAQC,IAC3BA,GAAU,IAUZlB,QAPyBmB,EAAAA,EAAAA,GAAoB,CAC3C3B,eACAC,gBACAC,cACAH,oBAIJ,CACF,GACF,E,eC5BA,QAXA,SACE6B,EACAC,EACA3B,GAEA,MAAM,MAAE4B,GACND,EAAqBE,IAAI,qCAAuC,CAAC,EAEnE,OAAOH,EAAiBI,2BAA2B9B,EAAa4B,EAAO,CAAC,EAC1E,E,oOCMA,MAAM,WAAEG,GAAeC,EAAAA,MAGvB,SAASC,EAA0BC,GACjC,MAAM,SACJC,EAAQ,YACRC,EAAW,gBACXC,EAAe,cACftC,EAAa,cACbuC,EAAa,gBACbzC,EAAe,iBACf0C,EAAgB,gBAChBC,GACEN,GAEE,kBACJO,EAAiB,iBACjBC,EAAgB,oBAChBC,EAAmB,sBACnBC,EAAqB,qBACrBjB,GACE9B,EAAgBM,SAEdH,EAAe,eAA4BD,IAGjD,GAAIqC,EAAYS,OAAS,EACvB,MAAM,IAAIC,MAAM,qDAGlB,MAAMhD,EAAesC,EAAY,IAE1BW,EAAcC,IAAuBC,EAAAA,EAAAA,OAGrCC,EAAoBC,IAAuBC,EAAAA,EAAAA,WAAS,IACpDC,EAAiBC,IAAsBF,EAAAA,EAAAA,UAAS,IAOhDG,EAAYC,IAAiBJ,EAAAA,EAAAA,UAAStD,EAAayD,aACnDE,EAAaC,IAAkBN,EAAAA,EAAAA,WAAUtD,EAAa6D,WACtDC,EAASC,IAAcT,EAAAA,EAAAA,UAAS,OAChCU,EAAoBC,IAAyBX,EAAAA,EAAAA,UAAS,CAC3DY,gBAAiB,KACjBC,cAAe,OAIXC,GAA0BC,EAAAA,EAAAA,QAAO,OAEjC,UAAEC,EAAS,oBAAEC,GAAwBtB,EAErCuB,EAAuBxE,EAAayE,yBACpCC,EAoUR,SAA0CF,GACxC,MAAMG,EAASH,EAAqBI,OAAO,GACrCF,EAA+B,CACnCG,UAAWF,EAAOE,UAClBC,YAAaH,EAAOG,YACpBC,WAAYJ,EAAOI,WACnBC,WAAYL,EAAOK,WACnBC,eAAgBN,EAAOM,eACvBC,UAAWP,EAAOO,UAClBC,kBAAmBR,EAAOQ,kBAC1BC,kBAAmBT,EAAOS,kBAC1BC,aAAcV,EAAOU,aACrBC,sBAAuBX,EAAOW,sBAC9BC,qBAAsBZ,EAAOY,sBAG/B,OAAOb,CACT,CArVuCc,CACnChB,GAGFJ,EAAwBqB,QAAU,CAChCC,WAAYlB,EACZmB,SAAUjB,GAQZ,MAAMkB,EAAmBC,IACvB9B,EAAW8B,EAAIC,OAAOhC,QAAQ,EAG1BiC,EAAoBA,KACxBhC,EAAW,KAAK,EAGZiC,GAAyBC,EAAAA,EAAAA,cAAY,KACzChD,GAAcqB,UAAU7C,SAAQ3B,IAAuB,IAAtB,cAAEG,GAAeH,EAChD4C,EAAgBwD,WAAW,oBAAqB,CAC9CjG,iBACA,GACF,GACD,CAACgD,IAEEkD,GAAyBF,EAAAA,EAAAA,cAAY,KACzC,MAAQG,UAAWC,GAAc5D,EAAiB6D,eAChD,2DAIAZ,WAAYlB,GACVJ,EAAwBqB,QAG5B,OACEc,EAAAA,cAACF,EAASG,EAAA,GACJpE,EAAK,CACTE,YAAa,CAACkC,EAAsBxE,GACpCuC,gBAAiB,CACfkE,aAAc,SACdvG,YAAaA,EACbwG,YAAanE,EAAgBmE,YAC7BC,WAAYpE,EAAgBoE,YAE9Bf,iBAAkBA,EAClBG,kBAAmBA,IACR,GAEd,CAAC9F,EAAeD,EAAcE,IAE3B0G,GAAkBX,EAAAA,EAAAA,cACtBY,IACEA,EAA0B,SAAdA,GAAwB,EAAI,EACxC,MAAMC,EAAiB9G,EAAa+G,sBAC9BC,EAAenE,EAAoBoE,gBAAgBH,IAEnD,SAAEI,GAAaF,EAEfG,EAAmBC,OAAOC,KAAKH,GAAUnE,OAE/C,IAAIuE,EAA0B/D,EAAkBsD,EAG5CS,GAA2BH,EAAmB,EAChDG,EAA0B,EACW,IAA5BA,IACTA,EAA0BH,EAAmB,GAG/CtE,EAAoB0E,oBAClBT,EACAQ,EACApH,GAEFsD,EAAmB8D,EAAwB,GAE7C,CAAC/D,KAGHiE,EAAAA,EAAAA,YAAU,KACJ7D,GAIJ8D,EAAgB,CACd1H,kBACAE,gBACAD,eACAG,oBAAqB,CAAC6F,KACrB0B,MAAKjE,IACFA,GACFC,GAAc,EAChB,GACA,GACD,CAAC3D,EAAiBE,EAAeD,EAAc2D,KAElD6D,EAAAA,EAAAA,YAAU,KACR,MAAM,YAAEG,GAAgB9E,EAAoB+E,UAC1C/E,EAAoBgF,OAAOC,+BAC3BjC,IAEIA,EAAI7F,aAAa+G,wBACjB/G,EAAa+G,uBAEbnD,GAAe,GAGbiC,EAAIkC,qBACNjF,EAAsBxB,KAAK,CACzB0G,MAAO,uBACPrH,QACE,iEACFE,KAAM,WAEV,IAIJ,MAAO,KACL8G,GAAa,CACd,GACA,CAAC3H,KAEJwH,EAAAA,EAAAA,YAAU,KACR,MAAM,YAAEG,GAAgB9E,EAAoB+E,UAC1C/E,EAAoBgF,OAAOI,0BAC3BC,IAAsC,IAArC,gBAAEhE,EAAe,YAAEiE,GAAaD,EAC/BjE,EAAsB,CACpBC,kBACAC,cAAegE,GACf,IAIN,MAAO,KACLR,GAAa,CACd,GACA,CAAC3H,KAKJwH,EAAAA,EAAAA,YAAU,KACR,MAAMY,EAAmCzF,EAAkBiF,UACzDjF,EAAkBkF,OAAOQ,sBACzBC,IAAgC,IAA/B,uBAAEC,GAAwBD,EACzB,MAAME,EAAiBlE,EAAUC,GAE/BgE,EAAuBE,SAASD,EAAezB,wBAE/C7D,EAAoBwF,0BAA0B,CAC5CzI,cAAesE,EACfgE,uBAAwB,IAE5B,IAIJ,MAAO,KACLH,EAAiCT,aAAa,CAC/C,GACA,KAEHH,EAAAA,EAAAA,YAAU,KACR,IAAImB,EAAY/F,EAAiBgG,aAAa1I,GAE9C,IAAIyI,EAYJ,OARAA,EAAYE,EACVjG,EACAf,EACA3B,GAGFmD,GAAoB,GAEb,KAELR,EAAoBiG,8CAClB5I,GAGF0C,EAAiBmG,iBAAiB7I,EAAY,CAC/C,GACA,KAEHsH,EAAAA,EAAAA,YAAU,KACR9D,EAAc1D,EAAayD,YAEpB,KAELZ,EAAoBiG,8CAClB5I,GAEFkE,EAAwBqB,QAAU,IAAI,IAEvC,CAACzF,IAGJ,IAAIgJ,EAAoB,KAExB,IACG5E,EAAwBqB,SACzBjB,EAAqBuC,wBACnB3C,EAAwBqB,QAAQC,WAAWqB,sBAE7C,OAAO,KAGL1E,GAAYA,EAASU,SACvBiG,EAAoB3G,EAAS4G,KAAI,CAACC,EAAOC,IAErCD,GACA3C,EAAAA,aAAmB2C,EAAO,CACxBjJ,gBACAmJ,IAAKD,OAMb,MAAM,UACJtE,EAAS,YACTC,EAAW,WACXC,EAAU,WACVC,EAAU,eACVC,GAAc,sBACdK,GAAqB,UACrBJ,GAAS,kBACTC,GAAiB,qBACjBI,GAAoB,aACpBF,IACEjB,EAAwBqB,QAAQE,SAE9B0D,GAAgB9I,UAOpByF,IACA,MAAMvC,QAAmB6F,EAAAA,EAAAA,GAAqB,CAC5CtJ,eACAC,gBACAF,oBAGF2D,EAAcD,EAAW,EAG3B,OACE8C,EAAAA,cAAAA,EAAAA,SAAA,KACEA,EAAAA,cAACgD,EAAAA,GAAiB,CAChBC,cAAe3D,IACbA,EAAI4D,kBACJ5D,EAAI6D,gBAAgB,EAEtBC,cAAe/C,EACfgD,mBAAoBA,IC/Ub,SAA4B9J,GAAgC,IAA/B,WAAE2D,EAAU,cAAE4F,GAAevJ,EACnE+J,EAAiB,KACjBC,EAAa,KAEjB,MAAM,EAAEC,IAAMC,EAAAA,EAAAA,IAAe,UACvBC,EAAUF,EAAE,QAElB,OAAQtG,GACN,KAAK,EACHqG,EAAaA,IAAMvD,EAAAA,cAAC2D,EAAAA,GAAI,CAACC,KAAK,iBAE9BN,EAAiBA,IACftD,EAAAA,cAAA,WAAK,yDAEP,MACF,KAAK,EACHuD,EAAaA,IAAMvD,EAAAA,cAAC2D,EAAAA,GAAI,CAACC,KAAK,qBAE9BN,EAAiBA,IAAMtD,EAAAA,cAAA,WAAK,gCAGhC,MAAM6D,EAAaA,IACjB7D,EAAAA,cAAA,OAAK8D,UAAU,wDACb9D,EAAAA,cAAA,OAAK8D,UAAU,+EACb9D,EAAAA,cAACuD,EAAU,MACXvD,EAAAA,cAAA,QAAM8D,UAAU,QAAO,cAEvB5G,GACA8C,EAAAA,cAAA,OACE8D,UAAU,6FAEVC,UAAWjB,GAEVY,IAMT,OACE1D,EAAAA,cAAAA,EAAAA,SAAA,KACGsD,GACCtD,EAAAA,cAACgE,EAAAA,EAAO,CAACC,QAASjE,EAAAA,cAACsD,EAAc,MAAKY,SAAS,eAC7ClE,EAAAA,cAAC6D,EAAU,QAGbP,GAAkBtD,EAAAA,cAAC6D,EAAU,MAGrC,CD+RiBM,CAAoB,CACzBjH,aACA4F,mBAGJsB,UAAW,CACTC,MAAOpI,EACPqI,eAAe,EACfC,UAAW7I,EAAWiD,IACtB6F,cAAe1F,GACf2F,kBAAoB,eAAc7F,KAClC8F,mBAAoB,CAClBC,YAAapG,EACTqG,EAAAA,QAAAA,MAAWC,SAAStG,EAAYuG,YAChC,GACJC,WAAYvG,GAAc,GAC1BwG,WAAYvG,GAAc,GAC1BwG,IAAK3G,GAAa,GAClB4G,UAAWxG,GAAkB,GAAEA,GAAeyG,QAAQ,OAAS,GAC/DC,aAC2BC,IAAzBrG,GACK,GAAEA,GAAqBmG,QAAQ,OAChC,GACNG,QAASvG,IAAyB,OAKxCiB,EAAAA,cAAA,OAAK8D,UAAU,wDACZ1G,GACC4C,EAAAA,cAACuF,EAAAA,GAA4B,CAC3BzB,UAAU,gBACV0B,aAAc/H,EAAmBG,cACjCD,gBAAiBF,EAAmBE,gBACpC8H,YAAY,wBAGf7F,IACA6C,GAIT,CAEA7G,EAA0B8J,UAAY,CACpC3J,YAAa4J,IAAAA,QAAkBA,IAAAA,QAC/BjM,cAAeiM,IAAAA,OAAiBC,WAChCC,WAAYF,IAAAA,OACZ7J,SAAU6J,IAAAA,KACVG,YAAaH,IAAAA,QAGf/J,EAA0BmK,aAAe,CACvCD,YAAa,CAAC,GAsBhB,S","sources":["webpack:///../../../extensions/cornerstone-dicom-rt/src/utils/promptHydrateRT.ts","webpack:///../../../extensions/cornerstone-dicom-rt/src/utils/initRTToolGroup.ts","webpack:///../../../extensions/cornerstone-dicom-rt/src/viewports/OHIFCornerstoneRTViewport.tsx","webpack:///../../../extensions/cornerstone-dicom-rt/src/viewports/_getStatusComponent.tsx"],"sourcesContent":["import { ButtonEnums } from '@ohif/ui';\nimport hydrateRTDisplaySet from './_hydrateRT';\n\nconst RESPONSE = {\n  NO_NEVER: -1,\n  CANCEL: 0,\n  HYDRATE_SEG: 5,\n};\n\nfunction promptHydrateRT({\n  servicesManager,\n  rtDisplaySet,\n  viewportIndex,\n  toolGroupId = 'default',\n  preHydrateCallbacks,\n}) {\n  const { uiViewportDialogService } = servicesManager.services;\n\n  return new Promise(async function(resolve, reject) {\n    const promptResult = await _askHydrate(\n      uiViewportDialogService,\n      viewportIndex\n    );\n\n    if (promptResult === RESPONSE.HYDRATE_SEG) {\n      preHydrateCallbacks?.forEach(callback => {\n        callback();\n      });\n\n      const isHydrated = await hydrateRTDisplaySet({\n        rtDisplaySet,\n        viewportIndex,\n        toolGroupId,\n        servicesManager,\n      });\n\n      resolve(isHydrated);\n    }\n  });\n}\n\nfunction _askHydrate(uiViewportDialogService, viewportIndex) {\n  return new Promise(function(resolve, reject) {\n    const message = 'Do you want to open this Segmentation?';\n    const actions = [\n      {\n        type: ButtonEnums.type.secondary,\n        text: 'No',\n        value: RESPONSE.CANCEL,\n      },\n      {\n        type: ButtonEnums.type.primary,\n        text: 'Yes',\n        value: RESPONSE.HYDRATE_SEG,\n      },\n    ];\n    const onSubmit = result => {\n      uiViewportDialogService.hide();\n      resolve(result);\n    };\n\n    uiViewportDialogService.show({\n      viewportIndex,\n      type: 'info',\n      message,\n      actions,\n      onSubmit,\n      onOutsideClick: () => {\n        uiViewportDialogService.hide();\n        resolve(RESPONSE.CANCEL);\n      },\n    });\n  });\n}\n\nexport default promptHydrateRT;\n","function createRTToolGroupAndAddTools(\n  ToolGroupService,\n  customizationService,\n  toolGroupId\n) {\n  const { tools } =\n    customizationService.get('cornerstone.overlayViewportTools') ?? {};\n\n  return ToolGroupService.createToolGroupAndAddTools(toolGroupId, tools, {});\n}\n\nexport default createRTToolGroupAndAddTools;\n","import React, { useCallback, useEffect, useRef, useState } from 'react';\nimport PropTypes from 'prop-types';\nimport OHIF, { utils } from '@ohif/core';\nimport {\n  ViewportActionBar,\n  useViewportGrid,\n  LoadingIndicatorTotalPercent,\n} from '@ohif/ui';\n\nimport _hydrateRTdisplaySet from '../utils/_hydrateRT';\nimport promptHydrateRT from '../utils/promptHydrateRT';\nimport _getStatusComponent from './_getStatusComponent';\nimport createRTToolGroupAndAddTools from '../utils/initRTToolGroup';\nimport _hydrateRTDisplaySet from '../utils/_hydrateRT';\n\nconst { formatDate } = utils;\nconst RT_TOOLGROUP_BASE_NAME = 'RTToolGroup';\n\nfunction OHIFCornerstoneRTViewport(props) {\n  const {\n    children,\n    displaySets,\n    viewportOptions,\n    viewportIndex,\n    viewportLabel,\n    servicesManager,\n    extensionManager,\n    commandsManager,\n  } = props;\n\n  const {\n    displaySetService,\n    toolGroupService,\n    segmentationService,\n    uiNotificationService,\n    customizationService,\n  } = servicesManager.services;\n\n  const toolGroupId = `${RT_TOOLGROUP_BASE_NAME}-${viewportIndex}`;\n\n  // RT viewport will always have a single display set\n  if (displaySets.length > 1) {\n    throw new Error('RT viewport should only have a single display set');\n  }\n\n  const rtDisplaySet = displaySets[0];\n\n  const [viewportGrid, viewportGridService] = useViewportGrid();\n\n  // States\n  const [isToolGroupCreated, setToolGroupCreated] = useState(false);\n  const [selectedSegment, setSelectedSegment] = useState(1);\n\n  // Hydration means that the RT is opened and segments are loaded into the\n  // segmentation panel, and RT is also rendered on any viewport that is in the\n  // same frameOfReferenceUID as the referencedSeriesUID of the RT. However,\n  // loading basically means RT loading over network and bit unpacking of the\n  // RT data.\n  const [isHydrated, setIsHydrated] = useState(rtDisplaySet.isHydrated);\n  const [rtIsLoading, setRtIsLoading] = useState(!rtDisplaySet.isLoaded);\n  const [element, setElement] = useState(null);\n  const [processingProgress, setProcessingProgress] = useState({\n    percentComplete: null,\n    totalSegments: null,\n  });\n\n  // refs\n  const referencedDisplaySetRef = useRef(null);\n\n  const { viewports, activeViewportIndex } = viewportGrid;\n\n  const referencedDisplaySet = rtDisplaySet.getReferenceDisplaySet();\n  const referencedDisplaySetMetadata = _getReferencedDisplaySetMetadata(\n    referencedDisplaySet\n  );\n\n  referencedDisplaySetRef.current = {\n    displaySet: referencedDisplaySet,\n    metadata: referencedDisplaySetMetadata,\n  };\n  /**\n   * OnElementEnabled callback which is called after the cornerstoneExtension\n   * has enabled the element. Note: we delegate all the image rendering to\n   * cornerstoneExtension, so we don't need to do anything here regarding\n   * the image rendering, element enabling etc.\n   */\n  const onElementEnabled = evt => {\n    setElement(evt.detail.element);\n  };\n\n  const onElementDisabled = () => {\n    setElement(null);\n  };\n\n  const storePresentationState = useCallback(() => {\n    viewportGrid?.viewports.forEach(({ viewportIndex }) => {\n      commandsManager.runCommand('storePresentation', {\n        viewportIndex,\n      });\n    });\n  }, [viewportGrid]);\n\n  const getCornerstoneViewport = useCallback(() => {\n    const { component: Component } = extensionManager.getModuleEntry(\n      '@ohif/extension-cornerstone.viewportModule.cornerstone'\n    );\n\n    const {\n      displaySet: referencedDisplaySet,\n    } = referencedDisplaySetRef.current;\n\n    // Todo: jump to the center of the first segment\n    return (\n      <Component\n        {...props}\n        displaySets={[referencedDisplaySet, rtDisplaySet]}\n        viewportOptions={{\n          viewportType: 'volume',\n          toolGroupId: toolGroupId,\n          orientation: viewportOptions.orientation,\n          viewportId: viewportOptions.viewportId,\n        }}\n        onElementEnabled={onElementEnabled}\n        onElementDisabled={onElementDisabled}\n      ></Component>\n    );\n  }, [viewportIndex, rtDisplaySet, toolGroupId]);\n\n  const onSegmentChange = useCallback(\n    direction => {\n      direction = direction === 'left' ? -1 : 1;\n      const segmentationId = rtDisplaySet.displaySetInstanceUID;\n      const segmentation = segmentationService.getSegmentation(segmentationId);\n\n      const { segments } = segmentation;\n\n      const numberOfSegments = Object.keys(segments).length;\n\n      let newSelectedSegmentIndex = selectedSegment + direction;\n\n      // Segment 0 is always background\n      if (newSelectedSegmentIndex >= numberOfSegments - 1) {\n        newSelectedSegmentIndex = 1;\n      } else if (newSelectedSegmentIndex === 0) {\n        newSelectedSegmentIndex = numberOfSegments - 1;\n      }\n\n      segmentationService.jumpToSegmentCenter(\n        segmentationId,\n        newSelectedSegmentIndex,\n        toolGroupId\n      );\n      setSelectedSegment(newSelectedSegmentIndex);\n    },\n    [selectedSegment]\n  );\n\n  useEffect(() => {\n    if (rtIsLoading) {\n      return;\n    }\n\n    promptHydrateRT({\n      servicesManager,\n      viewportIndex,\n      rtDisplaySet,\n      preHydrateCallbacks: [storePresentationState],\n    }).then(isHydrated => {\n      if (isHydrated) {\n        setIsHydrated(true);\n      }\n    });\n  }, [servicesManager, viewportIndex, rtDisplaySet, rtIsLoading]);\n\n  useEffect(() => {\n    const { unsubscribe } = segmentationService.subscribe(\n      segmentationService.EVENTS.SEGMENTATION_LOADING_COMPLETE,\n      evt => {\n        if (\n          evt.rtDisplaySet.displaySetInstanceUID ===\n          rtDisplaySet.displaySetInstanceUID\n        ) {\n          setRtIsLoading(false);\n        }\n\n        if (evt.overlappingSegments) {\n          uiNotificationService.show({\n            title: 'Overlapping Segments',\n            message:\n              'Overlapping segments detected which is not currently supported',\n            type: 'warning',\n          });\n        }\n      }\n    );\n\n    return () => {\n      unsubscribe();\n    };\n  }, [rtDisplaySet]);\n\n  useEffect(() => {\n    const { unsubscribe } = segmentationService.subscribe(\n      segmentationService.EVENTS.SEGMENT_LOADING_COMPLETE,\n      ({ percentComplete, numSegments }) => {\n        setProcessingProgress({\n          percentComplete,\n          totalSegments: numSegments,\n        });\n      }\n    );\n\n    return () => {\n      unsubscribe();\n    };\n  }, [rtDisplaySet]);\n\n  /**\n   Cleanup the SEG viewport when the viewport is destroyed\n   */\n  useEffect(() => {\n    const onDisplaySetsRemovedSubscription = displaySetService.subscribe(\n      displaySetService.EVENTS.DISPLAY_SETS_REMOVED,\n      ({ displaySetInstanceUIDs }) => {\n        const activeViewport = viewports[activeViewportIndex];\n        if (\n          displaySetInstanceUIDs.includes(activeViewport.displaySetInstanceUID)\n        ) {\n          viewportGridService.setDisplaySetsForViewport({\n            viewportIndex: activeViewportIndex,\n            displaySetInstanceUIDs: [],\n          });\n        }\n      }\n    );\n\n    return () => {\n      onDisplaySetsRemovedSubscription.unsubscribe();\n    };\n  }, []);\n\n  useEffect(() => {\n    let toolGroup = toolGroupService.getToolGroup(toolGroupId);\n\n    if (toolGroup) {\n      return;\n    }\n\n    toolGroup = createRTToolGroupAndAddTools(\n      toolGroupService,\n      customizationService,\n      toolGroupId\n    );\n\n    setToolGroupCreated(true);\n\n    return () => {\n      // remove the segmentation representations if seg displayset changed\n      segmentationService.removeSegmentationRepresentationFromToolGroup(\n        toolGroupId\n      );\n\n      toolGroupService.destroyToolGroup(toolGroupId);\n    };\n  }, []);\n\n  useEffect(() => {\n    setIsHydrated(rtDisplaySet.isHydrated);\n\n    return () => {\n      // remove the segmentation representations if seg displayset changed\n      segmentationService.removeSegmentationRepresentationFromToolGroup(\n        toolGroupId\n      );\n      referencedDisplaySetRef.current = null;\n    };\n  }, [rtDisplaySet]);\n\n  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n  let childrenWithProps = null;\n\n  if (\n    !referencedDisplaySetRef.current ||\n    referencedDisplaySet.displaySetInstanceUID !==\n      referencedDisplaySetRef.current.displaySet.displaySetInstanceUID\n  ) {\n    return null;\n  }\n\n  if (children && children.length) {\n    childrenWithProps = children.map((child, index) => {\n      return (\n        child &&\n        React.cloneElement(child, {\n          viewportIndex,\n          key: index,\n        })\n      );\n    });\n  }\n\n  const {\n    PatientID,\n    PatientName,\n    PatientSex,\n    PatientAge,\n    SliceThickness,\n    ManufacturerModelName,\n    StudyDate,\n    SeriesDescription,\n    SpacingBetweenSlices,\n    SeriesNumber,\n  } = referencedDisplaySetRef.current.metadata;\n\n  const onStatusClick = async () => {\n    // Before hydrating a RT and make it added to all viewports in the grid\n    // that share the same frameOfReferenceUID, we need to store the viewport grid\n    // presentation state, so that we can restore it after hydrating the RT. This is\n    // required if the user has changed the viewport (other viewport than RT viewport)\n    // presentation state (w/l and invert) and then opens the RT. If we don't store\n    // the presentation state, the viewport will be reset to the default presentation\n    storePresentationState();\n    const isHydrated = await _hydrateRTDisplaySet({\n      rtDisplaySet,\n      viewportIndex,\n      servicesManager,\n    });\n\n    setIsHydrated(isHydrated);\n  };\n\n  return (\n    <>\n      <ViewportActionBar\n        onDoubleClick={evt => {\n          evt.stopPropagation();\n          evt.preventDefault();\n        }}\n        onArrowsClick={onSegmentChange}\n        getStatusComponent={() => {\n          return _getStatusComponent({\n            isHydrated,\n            onStatusClick,\n          });\n        }}\n        studyData={{\n          label: viewportLabel,\n          useAltStyling: true,\n          studyDate: formatDate(StudyDate),\n          currentSeries: SeriesNumber,\n          seriesDescription: `RT Viewport ${SeriesDescription}`,\n          patientInformation: {\n            patientName: PatientName\n              ? OHIF.utils.formatPN(PatientName.Alphabetic)\n              : '',\n            patientSex: PatientSex || '',\n            patientAge: PatientAge || '',\n            MRN: PatientID || '',\n            thickness: SliceThickness ? `${SliceThickness.toFixed(2)}mm` : '',\n            spacing:\n              SpacingBetweenSlices !== undefined\n                ? `${SpacingBetweenSlices.toFixed(2)}mm`\n                : '',\n            scanner: ManufacturerModelName || '',\n          },\n        }}\n      />\n\n      <div className=\"relative flex flex-row w-full h-full overflow-hidden\">\n        {rtIsLoading && (\n          <LoadingIndicatorTotalPercent\n            className=\"w-full h-full\"\n            totalNumbers={processingProgress.totalSegments}\n            percentComplete={processingProgress.percentComplete}\n            loadingText=\"Loading RTSTRUCT...\"\n          />\n        )}\n        {getCornerstoneViewport()}\n        {childrenWithProps}\n      </div>\n    </>\n  );\n}\n\nOHIFCornerstoneRTViewport.propTypes = {\n  displaySets: PropTypes.arrayOf(PropTypes.object),\n  viewportIndex: PropTypes.number.isRequired,\n  dataSource: PropTypes.object,\n  children: PropTypes.node,\n  customProps: PropTypes.object,\n};\n\nOHIFCornerstoneRTViewport.defaultProps = {\n  customProps: {},\n};\n\nfunction _getReferencedDisplaySetMetadata(referencedDisplaySet) {\n  const image0 = referencedDisplaySet.images[0];\n  const referencedDisplaySetMetadata = {\n    PatientID: image0.PatientID,\n    PatientName: image0.PatientName,\n    PatientSex: image0.PatientSex,\n    PatientAge: image0.PatientAge,\n    SliceThickness: image0.SliceThickness,\n    StudyDate: image0.StudyDate,\n    SeriesDescription: image0.SeriesDescription,\n    SeriesInstanceUID: image0.SeriesInstanceUID,\n    SeriesNumber: image0.SeriesNumber,\n    ManufacturerModelName: image0.ManufacturerModelName,\n    SpacingBetweenSlices: image0.SpacingBetweenSlices,\n  };\n\n  return referencedDisplaySetMetadata;\n}\n\nexport default OHIFCornerstoneRTViewport;\n","import React from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { Icon, Tooltip } from '@ohif/ui';\n\nexport default function _getStatusComponent({ isHydrated, onStatusClick }) {\n  let ToolTipMessage = null;\n  let StatusIcon = null;\n\n  const { t } = useTranslation('Common');\n  const loadStr = t('LOAD');\n\n  switch (isHydrated) {\n    case true:\n      StatusIcon = () => <Icon name=\"status-alert\" />;\n\n      ToolTipMessage = () => (\n        <div>This Segmentation is loaded in the segmentation panel</div>\n      );\n      break;\n    case false:\n      StatusIcon = () => <Icon name=\"status-untracked\" />;\n\n      ToolTipMessage = () => <div>Click LOAD to load RTSTRUCT.</div>;\n  }\n\n  const StatusArea = () => (\n    <div className=\"flex h-6 leading-6 cursor-default text-sm text-white\">\n      <div className=\"min-w-[45px] flex items-center p-1 rounded-l-xl rounded-r bg-customgray-100\">\n        <StatusIcon />\n        <span className=\"ml-1\">RTSTRUCT</span>\n      </div>\n      {!isHydrated && (\n        <div\n          className=\"ml-1 px-1.5 rounded cursor-pointer hover:text-black bg-primary-main hover:bg-primary-light\"\n          // Using onMouseUp here because onClick is not working when the viewport is not active and is styled with pointer-events:none\n          onMouseUp={onStatusClick}\n        >\n          {loadStr}\n        </div>\n      )}\n    </div>\n  );\n\n  return (\n    <>\n      {ToolTipMessage && (\n        <Tooltip content={<ToolTipMessage />} position=\"bottom-left\">\n          <StatusArea />\n        </Tooltip>\n      )}\n      {!ToolTipMessage && <StatusArea />}\n    </>\n  );\n}\n"],"names":["RESPONSE","NO_NEVER","CANCEL","HYDRATE_SEG","_ref","servicesManager","rtDisplaySet","viewportIndex","toolGroupId","preHydrateCallbacks","uiViewportDialogService","services","Promise","async","resolve","reject","promptResult","message","actions","type","ButtonEnums","secondary","text","value","primary","onSubmit","result","hide","show","onOutsideClick","_askHydrate","forEach","callback","hydrateRTDisplaySet","ToolGroupService","customizationService","tools","get","createToolGroupAndAddTools","formatDate","utils","OHIFCornerstoneRTViewport","props","children","displaySets","viewportOptions","viewportLabel","extensionManager","commandsManager","displaySetService","toolGroupService","segmentationService","uiNotificationService","length","Error","viewportGrid","viewportGridService","useViewportGrid","isToolGroupCreated","setToolGroupCreated","useState","selectedSegment","setSelectedSegment","isHydrated","setIsHydrated","rtIsLoading","setRtIsLoading","isLoaded","element","setElement","processingProgress","setProcessingProgress","percentComplete","totalSegments","referencedDisplaySetRef","useRef","viewports","activeViewportIndex","referencedDisplaySet","getReferenceDisplaySet","referencedDisplaySetMetadata","image0","images","PatientID","PatientName","PatientSex","PatientAge","SliceThickness","StudyDate","SeriesDescription","SeriesInstanceUID","SeriesNumber","ManufacturerModelName","SpacingBetweenSlices","_getReferencedDisplaySetMetadata","current","displaySet","metadata","onElementEnabled","evt","detail","onElementDisabled","storePresentationState","useCallback","runCommand","getCornerstoneViewport","component","Component","getModuleEntry","React","_extends","viewportType","orientation","viewportId","onSegmentChange","direction","segmentationId","displaySetInstanceUID","segmentation","getSegmentation","segments","numberOfSegments","Object","keys","newSelectedSegmentIndex","jumpToSegmentCenter","useEffect","promptHydrateRT","then","unsubscribe","subscribe","EVENTS","SEGMENTATION_LOADING_COMPLETE","overlappingSegments","title","SEGMENT_LOADING_COMPLETE","_ref2","numSegments","onDisplaySetsRemovedSubscription","DISPLAY_SETS_REMOVED","_ref3","displaySetInstanceUIDs","activeViewport","includes","setDisplaySetsForViewport","toolGroup","getToolGroup","createRTToolGroupAndAddTools","removeSegmentationRepresentationFromToolGroup","destroyToolGroup","childrenWithProps","map","child","index","key","onStatusClick","_hydrateRTDisplaySet","ViewportActionBar","onDoubleClick","stopPropagation","preventDefault","onArrowsClick","getStatusComponent","ToolTipMessage","StatusIcon","t","useTranslation","loadStr","Icon","name","StatusArea","className","onMouseUp","Tooltip","content","position","_getStatusComponent","studyData","label","useAltStyling","studyDate","currentSeries","seriesDescription","patientInformation","patientName","OHIF","formatPN","Alphabetic","patientSex","patientAge","MRN","thickness","toFixed","spacing","undefined","scanner","LoadingIndicatorTotalPercent","totalNumbers","loadingText","propTypes","PropTypes","isRequired","dataSource","customProps","defaultProps"],"sourceRoot":""}