(self.webpackChunk=self.webpackChunk||[]).push([[150],{48228:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>O,hydrateSEGDisplaySet:()=>b.Z});const i=JSON.parse('{"u2":"@ohif/extension-cornerstone-dicom-seg"}').u2,a=`${i}.sopClassHandlerModule.dicom-seg`;var s=n(43001),o=n(61529),r=n(45754),l=n(91202),c=n(67540);const d=["1.2.840.10008.5.1.4.1.1.66.4"];let g={};function m(e,t,n){const i=e[0],{StudyInstanceUID:s,SeriesInstanceUID:m,SOPInstanceUID:S,SeriesDescription:u,SeriesNumber:p,SeriesDate:f,SOPClassUID:I,wadoRoot:v,wadoUri:y,wadoUriRoot:E}=i,D={Modality:"SEG",loading:!1,isReconstructable:!0,displaySetInstanceUID:o.utils.guid(),SeriesDescription:u,SeriesNumber:p,SeriesDate:f,SOPInstanceUID:S,SeriesInstanceUID:m,StudyInstanceUID:s,SOPClassHandlerId:a,SOPClassUID:I,referencedImages:null,referencedSeriesInstanceUID:null,referencedDisplaySetInstanceUID:null,isDerivedDisplaySet:!0,isLoaded:!1,isHydrated:!1,segments:{},sopClassUids:d,instance:i,instances:[i],wadoRoot:v,wadoUriRoot:E,wadoUri:y,isOverlayDisplaySet:!0},h=i.ReferencedSeriesSequence;if(!h)throw new Error("ReferencedSeriesSequence is missing for the SEG");const b=h[0];return D.referencedImages=i.ReferencedSeriesSequence.ReferencedInstanceSequence,D.referencedSeriesInstanceUID=b.SeriesInstanceUID,D.getReferenceDisplaySet=()=>{const{displaySetService:e}=t.services,n=e.getDisplaySetsForSeries(D.referencedSeriesInstanceUID);if(!n||0===n.length)throw new Error("Referenced DisplaySet is missing for the SEG");const i=n[0];D.referencedDisplaySetInstanceUID=i.displaySetInstanceUID,D.referencedVolumeURI=i.displaySetInstanceUID;const a=`cornerstoneStreamingImageVolume:${D.referencedVolumeURI}`;return D.referencedVolumeId=a,i},D.load=async e=>{let{headers:i}=e;return await function(e,t,n,i){const{SOPInstanceUID:a}=e,{segmentationService:s}=t.services;if((e.loading||e.isLoaded)&&g[a]&&function(e,t){return t.getSegmentation(e.displaySetInstanceUID)}(e,s))return g[a];return e.loading=!0,g[a]=new Promise((async(a,o)=>{e.segments&&0!==Object.keys(e.segments).length||await async function(e){let{extensionManager:t,servicesManager:n,segDisplaySet:i,headers:a}=e;const s=t.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{segmentationService:o}=n.services,{dicomLoaderService:d}=s.exports,g=await d.findDicomDataPromise(i,null,a),m=r.cache.getVolume(i.referencedVolumeId);if(!m)throw new Error("Referenced Volume is missing for the SEG, and stack viewport SEG is not supported yet");const{imageIds:S}=m,u=.001,p=!0;r.eventTarget.addEventListener(l.Yb.Events.SEGMENTATION_LOAD_PROGRESS,(e=>{const{percentComplete:t}=e.detail;o._broadcastEvent(o.EVENTS.SEGMENT_LOADING_COMPLETE,{percentComplete:t})}));const f=await l.ok.Cornerstone3D.Segmentation.generateToolState(S,g,r.metaData,{skipOverlapping:p,tolerance:u,eventTarget:r.eventTarget,triggerEvent:r.triggerEvent});f.segMetadata.data.forEach(((e,t)=>{var n;t>0&&(e.rgba=(n=e.RecommendedDisplayCIELabValue,c.default.data.Colors.dicomlab2RGB(n).map((e=>Math.round(255*e)))))})),Object.assign(i,f)}({extensionManager:n,servicesManager:t,segDisplaySet:e,headers:i});const d=!0;s.createSegmentationForSEGDisplaySet(e,null,d).then((()=>{e.loading=!1,a()})).catch((t=>{e.loading=!1,o(t)}))})),g[a]}(D,t,n,i)},[D]}const S=function(e){let{servicesManager:t,extensionManager:n}=e;return[{name:"dicom-seg",sopClassUids:d,getDisplaySetsFromSeries:e=>m(e,t,n)}]};var u=n(3827),p=n.n(u),f=n(60082);const I=function(e,t,n){const i="enter-segment-label",a=t=>{let{action:a,value:s}=t;switch(a.id){case"save":n(s.label,a.id);break;case"cancel":n("",a.id)}e.dismiss({id:i})};e&&e.create({id:i,centralize:!0,isDraggable:!1,showOverlay:!0,content:f.Vq,contentProps:{title:"Segment",value:{label:t},noCloseButton:!0,onClose:()=>e.dismiss({id:i}),actions:[{id:"cancel",text:"Cancel",type:f.LZ.U.secondary},{id:"save",text:"Confirm",type:f.LZ.U.primary}],onSubmit:a,body:e=>{let{value:t,setValue:n}=e;return s.createElement(f.II,{label:"Enter the segment label",labelClassName:"text-white text-[14px] leading-[1.2]",autoFocus:!0,className:"bg-black border-primary-main",type:"text",value:t.label,onChange:e=>{e.persist(),n((t=>({...t,label:e.target.value})))},onKeyPress:e=>{"Enter"===e.key&&a({value:t,action:{id:"save"}})}})}}})};var v=n(62657),y=n(69190);function E(e){let{servicesManager:t,commandsManager:n}=e;const{segmentationService:i,uiDialogService:a}=t.services,[o]=(0,v.M)(),r=o?.disableEditing,{t:l}=(0,y.$G)("PanelSegmentation"),[c,d]=(0,s.useState)(null),[g,m]=(0,s.useState)(i.getConfiguration()),[S,u]=(0,s.useState)((()=>i.getSegmentations())),[p,E]=(0,s.useState)({}),D=(0,s.useCallback)((e=>{E((t=>({...t,[e]:!t[e]})))}),[E]);(0,s.useEffect)((()=>{const e=S[S.length-1]?.id;e&&E((t=>({...t,[e]:!1})))}),[S,E]),(0,s.useEffect)((()=>{const e=i.EVENTS.SEGMENTATION_ADDED,t=i.EVENTS.SEGMENTATION_UPDATED,n=i.EVENTS.SEGMENTATION_REMOVED,a=[];return[e,t,n].forEach((e=>{const{unsubscribe:t}=i.subscribe(e,(()=>{const e=i.getSegmentations();u(e),m(i.getConfiguration())}));a.push(t)})),()=>{a.forEach((e=>{e()}))}}),[]);const h=e=>i.getToolGroupIdsWithSegmentation(e),b=(0,s.useCallback)(((e,t,n)=>{i.setConfiguration({segmentationId:e,[t]:n})}),[i]);return s.createElement("div",{className:"flex flex-col flex-auto min-h-0 justify-between mt-1"},S?.length?s.createElement(f.cX,{title:l("Segmentations"),showAddSegmentation:!1,segmentations:S,isMinimized:p,activeSegmentationId:c||"",onSegmentationClick:e=>{i.setActiveSegmentationForToolGroup(e)},onSegmentationDelete:e=>{i.remove(e)},onSegmentationEdit:e=>{const t=i.getSegmentation(e),{label:n}=t;I(a,n,((t,n)=>{""!==t&&i.addOrUpdateSegmentation({id:e,label:t},!1,!0)}))},onSegmentClick:(e,t)=>{i.setActiveSegmentForSegmentation(e,t);h(e).forEach((n=>{i.setActiveSegmentationForToolGroup(e,n),i.jumpToSegmentCenter(e,t,n)}))},onSegmentEdit:(e,t)=>{const n=i.getSegmentation(e).segments[t],{label:s}=n;I(a,s,((n,a)=>{""!==n&&i.setSegmentLabelForSegmentation(e,t,n)}))},disableEditing:r,onSegmentColorClick:(e,t)=>{},onSegmentDelete:(e,t)=>{console.warn("not implemented yet")},onToggleSegmentVisibility:(e,t)=>{const n=!i.getSegmentation(e).segments[t].isVisible;h(e).forEach((a=>{i.setSegmentVisibility(e,t,n,a)}))},onToggleSegmentationVisibility:e=>{i.toggleSegmentationVisibility(e)},onToggleMinimizeSegmentation:D,segmentationConfig:{initialConfig:g},setRenderOutline:e=>b(c,"renderOutline",e),setOutlineOpacityActive:e=>b(c,"outlineOpacity",e),setRenderFill:e=>b(c,"renderFill",e),setRenderInactiveSegmentations:e=>b(c,"renderInactiveSegmentations",e),setOutlineWidthActive:e=>b(c,"outlineWidthActive",e),setFillAlpha:e=>b(c,"fillAlpha",e),setFillAlphaInactive:e=>b(c,"fillAlphaInactive",e)}):null)}E.propTypes={commandsManager:p().shape({runCommand:p().func.isRequired}),appConfig:p().object.isRequired,servicesManager:p().shape({services:p().shape({segmentationService:p().shape({getSegmentation:p().func.isRequired,getSegmentations:p().func.isRequired,toggleSegmentationVisibility:p().func.isRequired,subscribe:p().func.isRequired,EVENTS:p().object.isRequired}).isRequired}).isRequired}).isRequired};const D={id:"@ohif/seg",name:"Segmentations",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{segDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SEG"}}]}},stages:[{name:"Segmentations",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"segDisplaySetId"}]}]}]};const h=function(){return[{name:D.id,protocol:D}]};var b=n(28417);function w(){return w=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},w.apply(this,arguments)}const M=s.lazy((()=>n.e(451).then(n.bind(n,4451)))),U=e=>s.createElement(s.Suspense,{fallback:s.createElement("div",null,"Loading...")},s.createElement(M,e)),O={id:i,getPanelModule:e=>{let{servicesManager:t,commandsManager:n,extensionManager:i}=e;return[{name:"panelSegmentation",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation",component:()=>s.createElement(E,{commandsManager:n,servicesManager:t,extensionManager:i})}]},getViewportModule(e){let{servicesManager:t,extensionManager:n}=e;return[{name:"dicom-seg",component:e=>s.createElement(U,w({servicesManager:t,extensionManager:n,commandsManager},e))}]},getSopClassHandlerModule:S,getHangingProtocolModule:h}},28417:(e,t,n)=>{"use strict";n.d(t,{Z:()=>i});const i=async function(e){let{segDisplaySet:t,viewportIndex:n,servicesManager:i}=e;const{segmentationService:a,hangingProtocolService:s,viewportGridService:o}=i.services,r=t.referencedDisplaySetInstanceUID;let l=null;l=await a.createSegmentationForSEGDisplaySet(t,l,!1),a.hydrateSegmentation(t.displaySetInstanceUID);const{viewports:c}=o.getState(),d=s.getViewportsRequireUpdate(n,r);return c.forEach(((e,i)=>{if(i===n)return;a.shouldRenderSegmentation(e.displaySetInstanceUIDs,t.displaySetInstanceUID)&&d.push({viewportIndex:i,displaySetInstanceUIDs:e.displaySetInstanceUIDs,viewportOptions:{initialImageOptions:{preset:"middle"}}})})),o.setDisplaySetsForViewports(d),!0}},78753:()=>{}}]);
//# sourceMappingURL=150.bundle.4f73d6a3e5f0cad6fce2.js.map